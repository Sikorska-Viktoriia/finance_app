#:kivy 2.3.1
#:import dp kivy.metrics.dp
#:import Window kivy.core.window.Window
#:import Platform kivy.utils.platform

#:set is_mobile True if Platform in ['android', 'ios'] else False
#:set screen_width Window.width
#:set screen_height Window.height
#:set is_small_screen screen_width < 400
#:set is_tablet screen_width >= 600

#:set scale_factor 1.0 if is_tablet else (0.9 if is_small_screen else 1.0)
#:set text_scale 1.0 if is_tablet else (0.9 if is_small_screen else 1.0)
#:set padding_scale 1.0 if is_tablet else (0.8 if is_small_screen else 1.0)

#:set adaptive_dp lambda x: dp(x * scale_factor)
#:set adaptive_font lambda x: dp(x * text_scale)
#:set adaptive_padding lambda x: dp(x * padding_scale)

#: set PRIMARY_PINK (0.95, 0.3, 0.5, 1)    # Яскравий рожевий
#: set LIGHT_PINK (1, 0.95, 0.95, 1)       # Світло-рожевий  
#: set PRIMARY_BLUE (0.2, 0.7, 0.9, 1)     # Яскравий блакитний
#: set LIGHT_BLUE (0.92, 0.98, 1.0, 1)     # Світло-блакитний
#: set SUCCESS_GREEN (0.2, 0.8, 0.3, 1)
#: set ERROR_RED (0.9, 0.2, 0.2, 1) 
#: set CREATION_BUTTON (0.95, 0.3, 0.5, 1)  # Рожевий для кнопки
#: set SELECTED_ITEM_COLOR (0.85, 0.95, 1.0, 1) # Виділення
#: set WHITE_BG (1, 1, 1, 1)               # Білий фон для модальних вікон
#: set DARK_TEXT (0.1, 0.1, 0.1, 1)        # Темний текст для модальних вікон

<BankCard>:
    size_hint: (0.85, 0.75)
    pos_hint: {'center_x': 0.5, 'center_y': 0.5}
    padding: adaptive_dp(20)
    spacing: adaptive_dp(12)
    
    canvas.before:
        Color:
            rgba: root.card_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [adaptive_dp(25),]
        # Додаємо тінь
        Color:
            rgba: 0, 0, 0, 0.1
        RoundedRectangle:
            pos: (self.x - adaptive_dp(2), self.y - adaptive_dp(2))
            size: self.size
            radius: [adaptive_dp(25),]

    BoxLayout:
        orientation: 'vertical'
        spacing: adaptive_dp(8)
        
        # Заголовок банку
        BoxLayout:
            size_hint_y: None
            height: adaptive_dp(30)
            spacing: adaptive_dp(8)
            
            Label:
                text: root.get_bank_icon()
                font_size: adaptive_font(20)
                color: (1, 1, 1, 0.9)
                size_hint_x: None
                width: adaptive_dp(40)
                bold: True
            
            Label:
                text: root.bank_name
                font_size: adaptive_font(16)
                color: (1, 1, 1, 0.8)
                halign: 'left'
                text_size: self.width, None
        
        # Назва картки
        Label:
            text: root.card_name
            font_size: adaptive_font(22)
            bold: True
            color: (1, 1, 1, 1)
            size_hint_y: None
            height: adaptive_dp(35)
            text_size: self.width, None
            halign: 'left'
        
        # Номер картки
        Label:
            text: root.card_number
            font_size: adaptive_font(18)
            color: (1, 1, 1, 0.9)
            size_hint_y: None
            height: adaptive_dp(30)
            text_size: self.width, None
            halign: 'left'
        
        Widget:
            size_hint_y: 1
        
        # Баланс
        BoxLayout:
            size_hint_y: None
            height: adaptive_dp(40)
            spacing: adaptive_dp(10)
            
            Label:
                text: "Баланс:"
                font_size: adaptive_font(16)
                color: (1, 1, 1, 0.8)
                size_hint_x: None
                width: adaptive_dp(80)
            
            Label:
                text: f"{root.balance:.2f} $"
                font_size: adaptive_font(24)
                bold: True
                color: (1, 1, 1, 1)
                halign: 'right'
                text_size: self.width, None

<CreateCardModal@ModalView>:
    background_color: 0, 0, 0, 0.5
    size_hint: (0.8, 0.6)
    auto_dismiss: False
    
    BoxLayout:
        orientation: 'vertical'
        size: root.size
        pos: root.pos
        padding: adaptive_dp(30)
        
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            padding: adaptive_dp(20)
            spacing: adaptive_dp(20)
            canvas.before:
                Color:
                    rgba: WHITE_BG
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [adaptive_dp(20),]
            
            # Заголовок
            Label:
                text: "Створити нову картку"
                font_size: adaptive_font(24)
                bold: True
                color: PRIMARY_PINK
                size_hint_y: None
                height: adaptive_dp(50)
                text_size: self.width, None
                halign: 'center'
            
            # Поля вводу
            BoxLayout:
                orientation: 'vertical'
                spacing: adaptive_dp(15)
                size_hint_y: None
                height: adaptive_dp(250)
                
                # Назва картки
                BoxLayout:
                    orientation: 'vertical'
                    spacing: adaptive_dp(5)
                    size_hint_y: None
                    height: adaptive_dp(70)
                    
                    Label:
                        text: "Назва картки:"
                        font_size: adaptive_font(16)
                        color: DARK_TEXT
                        size_hint_y: None
                        height: adaptive_dp(25)
                        text_size: self.width, None
                        halign: 'left'
                    
                    StyledTextInput:
                        id: card_name_input
                        hint_text: "Наприклад: Основна картка"
                        size_hint_y: None
                        height: adaptive_dp(45)
                
                # Номер картки
                BoxLayout:
                    orientation: 'vertical'
                    spacing: adaptive_dp(5)
                    size_hint_y: None
                    height: adaptive_dp(70)
                    
                    Label:
                        text: "Номер картки (16 цифр):"
                        font_size: adaptive_font(16)
                        color: DARK_TEXT
                        size_hint_y: None
                        height: adaptive_dp(25)
                        text_size: self.width, None
                        halign: 'left'
                    
                    StyledTextInput:
                        id: card_number_input
                        hint_text: "0000000000000000"
                        input_filter: 'int'
                        size_hint_y: None
                        height: adaptive_dp(45)
                
                # Вибір банку
                BoxLayout:
                    orientation: 'vertical'
                    spacing: adaptive_dp(5)
                    size_hint_y: None
                    height: adaptive_dp(70)
                    
                    Label:
                        text: "Банк:"
                        font_size: adaptive_font(16)
                        color: DARK_TEXT
                        size_hint_y: None
                        height: adaptive_dp(25)
                        text_size: self.width, None
                        halign: 'left'
                    
                    Spinner:
                        id: bank_spinner
                        text: "ПриватБанк"
                        values: ["ПриватБанк", "Монобанк", "Райффайзен", "Ощадбанк", "Укрексімбанк", "Інший"]
                        size_hint_y: None
                        height: adaptive_dp(45)
                        background_color: PRIMARY_BLUE
                        color: (1, 1, 1, 1)
                        font_size: adaptive_font(16)
            
            # Повідомлення про помилку
            Label:
                id: error_label
                text: ""
                color: ERROR_RED
                size_hint_y: None
                height: adaptive_dp(30)
                text_size: self.width, None
                halign: 'center'
            
            # Кнопки
            BoxLayout:
                orientation: 'horizontal'
                spacing: adaptive_dp(15)
                size_hint_y: None
                height: adaptive_dp(55)
                
                StyledButton:
                    text: "Скасувати"
                    background_color: ERROR_RED
                    on_press: root.dismiss()
                
                StyledButton:
                    text: "Створити"
                    background_color: SUCCESS_GREEN
                    on_press: app.root.get_screen('dashboard_screen').ids.tab_manager.get_screen('home_tab').create_card_from_modal(card_name_input.text, card_number_input.text, bank_spinner.text)

<WhitePopup>:
    background_color: 1, 1, 1, 1
    title_color: 0.1, 0.1, 0.1, 1
    separator_color: 0.9, 0.9, 0.9, 1
    separator_height: 1

<WhiteButton>:
    background_normal: ''
    background_color: 0.2, 0.7, 0.9, 1
    color: 1, 1, 1, 1
    font_size: 16
    size_hint_y: None
    height: 45

<WhiteTextInput>:
    multiline: False
    padding: [12, 12]
    background_color: 1, 1, 1, 1
    background_normal: ''
    background_active: ''
    foreground_color: 0.1, 0.1, 0.1, 1
    font_size: 16
    size_hint_y: None
    height: 45
    cursor_color: 0.1, 0.1, 0.1, 1

<GradientBox@BoxLayout>:
    color1: 1, 1, 1, 1
    canvas.before:
        Color:
            rgba: self.color1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [adaptive_dp(30),]

<StyledButton@Button>:
    background_normal: ''
    background_color: 1, 1, 1, 1
    color: 1, 1, 1, 1
    font_size: adaptive_font(18)
    size_hint_y: None
    height: adaptive_dp(60)
    canvas.before:
        Color:
            rgba: self.background_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [adaptive_dp(15),]

<AppLogo@RelativeLayout>:
    size_hint_y: None
    height: adaptive_dp(150) if not is_small_screen else adaptive_dp(120)
    Image:
        source: "flamingo_logo.png"
        size_hint: None, None
        size: adaptive_dp(130), adaptive_dp(130) if not is_small_screen else (adaptive_dp(100), adaptive_dp(100))
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}

<LoginFormLogo@RelativeLayout>:
    size_hint_y: None
    height: adaptive_dp(120) if not is_small_screen else adaptive_dp(90)
    Image:
        source: "flamingo_logo.png"
        size_hint: None, None
        size: adaptive_dp(110), adaptive_dp(110) if not is_small_screen else (adaptive_dp(80), adaptive_dp(80))
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}

<StyledTextInput@TextInput>:
    multiline: False
    padding: [adaptive_dp(15), adaptive_dp(17)]
    background_color: 1, 1, 1, 0
    background_normal: ''
    background_active: ''
    foreground_color: 0.05, 0.05, 0.15, 1
    font_size: adaptive_font(18)
    size_hint_y: None
    height: adaptive_dp(55) if not is_small_screen else adaptive_dp(45)
    cursor_color: 0.05, 0.05, 0.15, 1
    canvas.before:
        Color:
            rgba: 1, 1, 1, 1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [adaptive_dp(10),]
        Color:
            rgba: 0.8, 0.8, 0.8, 1
        Line:
            rounded_rectangle: [self.x, self.y, self.width, self.height, adaptive_dp(10)]
            width: 1

<PasswordTextInput>:
    size_hint_y: None
    height: adaptive_dp(55) if not is_small_screen else adaptive_dp(45)
    RelativeLayout:
        size_hint: 1, 1
        
        TextInput:
            id: password_input
            text: root.text
            hint_text: root.hint_text
            password: root.password
            multiline: False
            padding: [adaptive_dp(15), (self.height - self.line_height) / 2, adaptive_dp(55), (self.height - self.line_height) / 2]
            background_color: 1, 1, 1, 0
            background_normal: ''
            background_active: ''
            foreground_color: 0.05, 0.05, 0.15, 1
            font_size: adaptive_font(18)
            size_hint: 1, 1
            cursor_color: 0.05, 0.05, 0.15, 1
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [adaptive_dp(10),]
                Color:
                    rgba: 0.8, 0.8, 0.8, 1
                Line:
                    rounded_rectangle: [self.x, self.y, self.width, self.height, adaptive_dp(10)]
                    width: 1
        
        Button:
            size_hint: None, None
            size: adaptive_dp(45), adaptive_dp(45) if not is_small_screen else (adaptive_dp(35), adaptive_dp(35))
            pos_hint: {'right': 0.98, 'center_y': 0.5}
            background_color: 0, 0, 0, 0
            background_normal: ''
            on_press: root.toggle_password()

            Image:
                source: "icons/eye_open.png" if root.password else "icons/eye_closed.png"
                size_hint: None, None
                size: adaptive_dp(28), adaptive_dp(28) if not is_small_screen else (adaptive_dp(22), adaptive_dp(22))
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                center: self.parent.center_x, self.parent.center_y

<BottomMenuItem>:
    orientation: 'vertical'
    size_hint_x: 1
    spacing: adaptive_dp(5)
    padding: [adaptive_dp(5), adaptive_dp(5), adaptive_dp(5), adaptive_dp(10)]
    
    Image:
        source: root.icon_source
        size_hint: None, None
        size: adaptive_dp(35), adaptive_dp(35) if not is_small_screen else (adaptive_dp(28), adaptive_dp(28))
        pos_hint: {'center_x': 0.5}


<SavingsPlanItem>:
    is_selected: False
    plan_id: 0 
    plan_name: "" 
    current_amount: 0.0
    target_amount: 0.0
    progress: 0
    days_left: 0
    
    size_hint_y: None
    height: dp(90) 
    padding: dp(15)
    
    canvas.before:
        Color:
            rgba: SELECTED_ITEM_COLOR if root.is_selected else LIGHT_PINK
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(15),]
        Color:
            rgba: PRIMARY_PINK if root.is_selected else (0.7, 0.7, 0.7, 1)
        Line:
            rounded_rectangle: [self.x, self.y, self.width, self.height, dp(15)]
            width: 2.5 if root.is_selected else 1
            
    BoxLayout:
        orientation: 'horizontal'
        spacing: dp(12)
        
        Image:
            source: "icons/piggy_bank.png"
            size_hint: None, None
            size: dp(45), dp(45)
            pos_hint: {'center_y': 0.5}
        
        BoxLayout:
            orientation: 'vertical'
            padding: dp(2)
            spacing: dp(5)
            
            BoxLayout:
                size_hint_y: None
                height: dp(30)
                
                Label:
                    text: root.plan_name
                    font_size: dp(16)
                    color: PRIMARY_PINK
                    halign: 'left'
                    text_size: self.size
                    size_hint_x: 0.6
                    bold: True
                
                Label:
                    text: f"${root.current_amount:.2f} / ${root.target_amount:.2f}"
                    font_size: dp(14)
                    color: PRIMARY_BLUE
                    halign: 'right'
                    text_size: self.size
                    size_hint_x: 0.4
                    bold: True
                    
            BoxLayout:
                size_hint_y: None
                height: dp(20)
                spacing: dp(8)
                
                ProgressBar:
                    value: root.progress
                    max: 100
                    size_hint_x: 0.65
                    background_color: 0.9, 0.9, 0.9, 1
                    foreground_color: PRIMARY_BLUE
                    
                Label:
                    text: f"{root.progress:.0f}%"
                    font_size: dp(12)
                    color: PRIMARY_PINK
                    size_hint_x: 0.15
                    bold: True
                
                Label:
                    text: f"{root.days_left} дн." if root.days_left > 0 else "∞"
                    font_size: dp(12)
                    color: PRIMARY_BLUE if root.days_left > 30 else ERROR_RED
                    size_hint_x: 0.2
                    bold: True

<StartScreen>:
    name: 'start_screen'
    canvas.before:
        Color:
            rgba: PRIMARY_BLUE
        Rectangle:
            pos: self.pos
            size: self.size
    GradientBox:
        color1: 0.9, 0.95, 1.0, 0
        orientation: 'vertical'
        padding: adaptive_padding(40)
        spacing: adaptive_dp(30)
        
        AppLogo:
            height: adaptive_dp(150) if not is_small_screen else adaptive_dp(120)

        Label:
            text: "Flamingo Cash"
            font_size: adaptive_font(48) if not is_small_screen else adaptive_font(36)
            bold: True
            color: 1, 1, 1, 1
            size_hint_y: None
            height: adaptive_dp(60) if not is_small_screen else adaptive_dp(45)

        Label:
            text: "Your modern financial assistant"
            font_size: adaptive_font(18) if not is_small_screen else adaptive_font(16)
            color: 1, 1, 1, 0.8
            size_hint_y: None
            height: adaptive_dp(25)

        Widget:

        StyledButton:
            text: "Login"
            background_color: PRIMARY_PINK
            on_press:
                root.manager.transition.direction = 'left'
                root.manager.current = "login_screen"

        StyledButton:
            text: "Register"
            background_color: 1, 1, 1, 1
            color: PRIMARY_PINK
            on_press:
                root.manager.transition.direction = 'left'
                root.manager.current = "registration_screen"

<RegistrationScreen>:
    name: "registration_screen"
    canvas.before:
        Color:
            rgba: LIGHT_BLUE
        Rectangle:
            pos: self.pos
            size: self.size
    GradientBox:
        color1: 1.0, 0.98, 0.98, 0
        orientation: "vertical"
        padding: adaptive_padding(30)
        spacing: adaptive_dp(20)
        
        LoginFormLogo:
            height: adaptive_dp(100) if not is_small_screen else adaptive_dp(80)

        Label:
            text: "Створити обліковий запис"
            font_size: adaptive_font(30) if not is_small_screen else adaptive_font(24)
            bold: True
            color: PRIMARY_PINK
            size_hint_y: None
            height: adaptive_dp(40)

        BoxLayout:
            orientation: "vertical"
            spacing: adaptive_dp(15)
            size_hint_y: None
            height: adaptive_dp(275) if not is_small_screen else adaptive_dp(220)

            StyledTextInput:
                id: username
                hint_text: "Ім'я користувача"
            
            StyledTextInput:
                id: email
                hint_text: "Електронна пошта"
                    
            PasswordTextInput:
                id: password_field
                hint_text: "Пароль"

            PasswordTextInput:
                id: password_confirm_field
                hint_text: "Підтвердіть пароль"

        StyledButton:
            text: "Зареєструватися"
            background_color: PRIMARY_PINK
            size_hint_y: None
            height: adaptive_dp(60) if not is_small_screen else adaptive_dp(50)
            on_press: root.register_user()

        Label:
            id: reg_message
            text: ""
            color: ERROR_RED
            size_hint_y: None
            height: adaptive_dp(30)

        BoxLayout:
            size_hint_y: None
            height: adaptive_dp(40)
            Label:
                text: "Вже маєте обліковий запис?"
                color: 0.2, 0.2, 0.2, 1
                font_size: adaptive_font(14)
            StyledButton:
                text: "Увійти"
                background_color: 0.8, 0.8, 0.8, 0
                color: PRIMARY_BLUE
                font_size: adaptive_font(16)
                bold: True
                size_hint_x: 0.5
                size_hint_y: None
                height: adaptive_dp(40)
                on_press: root.manager.current = 'login_screen'

<LoginScreen>:
    name: "login_screen"
    canvas.before:
        Color:
            rgba: LIGHT_BLUE
        Rectangle:
            pos: self.pos
            size: self.size
    GradientBox:
        color1: 0.9, 0.95, 1.0, 0
        orientation: "vertical"
        padding: adaptive_padding(30)
        spacing: adaptive_dp(25)

        LoginFormLogo:
            height: adaptive_dp(120) if not is_small_screen else adaptive_dp(90)

        Label:
            text: "Вхід до системи"
            font_size: adaptive_font(34) if not is_small_screen else adaptive_font(28)
            bold: True
            color: PRIMARY_PINK
            size_hint_y: None
            height: adaptive_dp(50)
        
        BoxLayout:
            orientation: "vertical"
            spacing: adaptive_dp(15)
            size_hint_y: None
            height: adaptive_dp(125) if not is_small_screen else adaptive_dp(100)

            StyledTextInput:
                id: email
                hint_text: "Електронна пошта"

            PasswordTextInput:
                id: password_field
                hint_text: "Пароль"

        StyledButton:
            text: "Увійти"
            background_color: PRIMARY_BLUE
            size_hint_y: None
            height: adaptive_dp(60) if not is_small_screen else adaptive_dp(50)
            on_press: root.login_user()

        Label:
            id: login_message
            text: ""
            color: ERROR_RED
            size_hint_y: None
            height: adaptive_dp(30)

        Widget:
            size_hint_y: 1
        
        BoxLayout:
            size_hint_y: None
            height: adaptive_dp(40)
            Label:
                text: "Ще не маєте облікового запису?"
                color: 0.2, 0.2, 0.2, 1
                font_size: adaptive_font(14)
            StyledButton:
                text: "Зареєструватися"
                background_color: 0.8, 0.8, 0.8, 0
                color: PRIMARY_PINK
                font_size: adaptive_font(16)
                bold: True
                size_hint_x: 0.5
                size_hint_y: None
                height: adaptive_dp(40)
                on_press: root.manager.current = 'registration_screen'

<HomeTab>:
    name: "home_tab"
    canvas.before:
        Color:
            rgba: LIGHT_BLUE
        Rectangle:
            pos: self.pos
            size: self.size
    
    BoxLayout:
        orientation: "vertical"
        padding: dp(20)
        spacing: dp(15)
        
        # Верхня частина - привітання
        BoxLayout:
            orientation: "vertical"
            size_hint_y: None
            height: dp(100)
            spacing: dp(8)
            
            Label:
                id: welcome_label
                text: "Ласкаво просимо!"
                font_size: dp(24)
                bold: True
                color: PRIMARY_PINK
                size_hint_y: None
                height: dp(40)
                text_size: self.width, None
                halign: 'center'
            
            Label:
                id: balance_label
                text: "Баланс: 0.00 $"
                font_size: dp(20)
                color: PRIMARY_BLUE
                size_hint_y: None
                height: dp(35)
                text_size: self.width, None
                halign: 'center'
        
        # Фільтри банків
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(45)
            spacing: dp(8)
            
            Button:
                text: "Всі"
                background_color: PRIMARY_BLUE if root.current_filter == "Всі" else (0.7, 0.7, 0.7, 1)
                color: (1, 1, 1, 1) if root.current_filter == "Всі" else (0.3, 0.3, 0.3, 1)
                font_size: dp(14)
                size_hint_x: 0.2
                on_press: root.change_bank_filter("Всі")
            
            Button:
                text: "Приват"
                background_color: PRIMARY_BLUE if root.current_filter == "ПриватБанк" else (0.7, 0.7, 0.7, 1)
                color: (1, 1, 1, 1) if root.current_filter == "ПриватБанк" else (0.3, 0.3, 0.3, 1)
                font_size: dp(14)
                size_hint_x: 0.2
                on_press: root.change_bank_filter("ПриватБанк")
            
            Button:
                text: "Моно"
                background_color: PRIMARY_BLUE if root.current_filter == "Монобанк" else (0.7, 0.7, 0.7, 1)
                color: (1, 1, 1, 1) if root.current_filter == "Монобанк" else (0.3, 0.3, 0.3, 1)
                font_size: dp(14)
                size_hint_x: 0.2
                on_press: root.change_bank_filter("Монобанк")
            
            Button:
                text: "Інші"
                background_color: PRIMARY_BLUE if root.current_filter not in ["Всі", "ПриватБанк", "Монобанк"] else (0.7, 0.7, 0.7, 1)
                color: (1, 1, 1, 1) if root.current_filter not in ["Всі", "ПриватБанк", "Монобанк"] else (0.3, 0.3, 0.3, 1)
                font_size: dp(14)
                size_hint_x: 0.4
                on_press: root.change_bank_filter("Інший")
        
    
        
        # Карусель з картками
        BoxLayout:
            id: cards_container
            size_hint_y: 0.45
            padding: [adaptive_dp(10), 0]
        
        # Керування коштами
        GradientBox:
            color1: LIGHT_PINK
            orientation: 'vertical'
            size_hint_y: None
            height: adaptive_dp(140) if not is_small_screen else adaptive_dp(120)
            padding: adaptive_padding(15)
            spacing: adaptive_dp(12)
            
            Label:
                text: "Керування коштами"
                font_size: adaptive_font(18)
                bold: True
                color: PRIMARY_PINK
                size_hint_y: None
                height: adaptive_dp(30)
                text_size: self.width, None
                halign: 'center'
            
            BoxLayout:
                orientation: 'horizontal'
                spacing: adaptive_dp(12)
                size_hint_y: None
                height: adaptive_dp(55) if not is_small_screen else adaptive_dp(45)
                
                StyledTextInput:
                    id: amount_input
                    hint_text: "Сума"
                    input_filter: "float"
                    size_hint_x: 0.5
                    font_size: adaptive_font(16)
                
                BoxLayout:
                    orientation: 'horizontal'
                    spacing: adaptive_dp(8)
                    size_hint_x: 0.5
                    
                    StyledButton:
                        text: "Поповнити"
                        background_color: SUCCESS_GREEN
                        font_size: adaptive_font(14)
                        on_press: root.add_money()
                    
                    StyledButton:
                        text: "Зняти"
                        background_color: ERROR_RED
                        font_size: adaptive_font(14)
                        on_press: root.remove_money()
            
            Label:
                id: money_message
                text: ""
                font_size: adaptive_font(12)
                color: PRIMARY_BLUE
                size_hint_y: None
                height: adaptive_dp(20)
                text_size: self.width, None
                halign: 'center'
        
        # Історія транзакцій
        GradientBox:
            color1: LIGHT_PINK
            orientation: 'vertical'
            size_hint_y: 0.35
            padding: adaptive_padding(15)
            spacing: adaptive_dp(10)
            
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: adaptive_dp(35)
                
                Label:
                    text: "Останні транзакції"
                    font_size: adaptive_font(18)
                    bold: True
                    color: PRIMARY_PINK
                    text_size: self.width, None
                    halign: 'left'
                
                Label:
                    id: transactions_count
                    text: ""
                    font_size: adaptive_font(14)
                    color: PRIMARY_BLUE
                    text_size: self.width, None
                    halign: 'right'
            
            ScrollView:
                size_hint_y: 1
                do_scroll_x: False
                bar_width: adaptive_dp(6)
                bar_color: PRIMARY_BLUE
                bar_inactive_color: PRIMARY_BLUE
                
                BoxLayout:
                    id: history_container
                    orientation: 'vertical'
                    spacing: adaptive_dp(8)
                    size_hint_y: None
                    height: self.minimum_height
                    padding: [adaptive_dp(5), adaptive_dp(5)]

# Стиль для елементів історії транзакцій
<TransactionItem@BoxLayout>:
    orientation: 'horizontal'
    size_hint_y: None
    height: adaptive_dp(40)
    padding: [adaptive_dp(10), 0]
    spacing: adaptive_dp(10)
    
    canvas.before:
        Color:
            rgba: (1, 1, 1, 0.7)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [adaptive_dp(10),]
    
    Label:
        text: root.date
        font_size: adaptive_font(12)
        color: (0.3, 0.3, 0.3, 1)
        size_hint_x: 0.25
        text_size: self.width, None
        halign: 'left'
    
    Label:
        text: root.description
        font_size: adaptive_font(14)
        color: (0.1, 0.1, 0.1, 1)
        size_hint_x: 0.45
        text_size: self.width, None
        halign: 'left'
    
    Label:
        text: root.amount
        font_size: adaptive_font(14)
        color: root.amount_color
        size_hint_x: 0.3
        text_size: self.width, None
        halign: 'right'
        bold: True

<AnalyticsTab>:
    name: "analytics_tab"
    canvas.before:
        Color:
            rgba: LIGHT_BLUE
        Rectangle:
            pos: self.pos
            size: self.size
    
    BoxLayout:
        orientation: 'vertical'
        padding: adaptive_padding(40)
        spacing: adaptive_dp(20)
        
        LoginFormLogo:
            height: adaptive_dp(120) if not is_small_screen else adaptive_dp(90)
        
        Label:
            text: "Analytics"
            font_size: adaptive_font(28) if not is_small_screen else adaptive_font(24)
            bold: True
            color: PRIMARY_PINK
            size_hint_y: None
            height: adaptive_dp(40)
        
        Label:
            text: "Transaction history and charts will appear here"
            font_size: adaptive_font(18) if not is_small_screen else adaptive_font(16)
            color: PRIMARY_BLUE
            halign: "center"
            text_size: self.width, None



<SavingsTab>:
    name: 'savings_tab'
    selected_plan_id: 0
    
    canvas.before:
        Color:
            rgba: LIGHT_BLUE
        Rectangle:
            pos: self.pos
            size: self.size
    
    BoxLayout:
        orientation: 'vertical'
        padding: adaptive_padding(20)
        spacing: adaptive_dp(20)
        
        # 1. БЛОК СТВОРЕННЯ НОВОГО ПЛАНУ
        GradientBox:
            color1: LIGHT_PINK
            orientation: 'vertical'
            padding: adaptive_padding(15)
            spacing: adaptive_dp(15)
            
            Label:
                text: 'Створити Новий План Заощаджень'
                font_size: adaptive_font(18)
                color: PRIMARY_PINK
                size_hint_y: None
                height: adaptive_dp(30)
                bold: True

            BoxLayout:
                orientation: 'horizontal'
                spacing: adaptive_dp(10)
                size_hint_y: None
                height: adaptive_dp(55) if not is_small_screen else adaptive_dp(45)
                
                StyledTextInput:
                    id: plan_name_input
                    hint_text: 'Назва плану...'
                    size_hint_x: 0.35
                    background_color: 1, 1, 1, 1
                
                StyledTextInput:
                    id: target_amount_input
                    hint_text: 'Цільова сума ($)'
                    input_filter: 'float'
                    size_hint_x: 0.3
                    background_color: 1, 1, 1, 1
                
                BoxLayout:
                    orientation: 'horizontal'
                    spacing: adaptive_dp(5)
                    size_hint_x: 0.35
                    
                    StyledTextInput:
                        id: deadline_input
                        hint_text: 'Дедлайн'
                        size_hint_x: 0.7
                        background_color: 1, 1, 1, 1
                    
                    StyledButton:
                        size_hint_x: 0.3
                        background_color: PRIMARY_BLUE
                        on_press: root.show_calendar()
                        padding: adaptive_dp(5)
                        BoxLayout:
                            size: self.parent.size
                            pos: self.parent.pos
                            Image:
                                source: "icons/calendar.png"
                                size_hint: None, None
                                size: adaptive_dp(22), adaptive_dp(22)
                                pos_hint: {'center_x': 0.5, 'center_y': 0.5}

            # ВИПРАВЛЕНА КНОПКА - ВИДАЛЕНО ДУБЛЮВАННЯ ТЕКСТУ
            StyledButton:
                text: "Створити План"
                background_color: PRIMARY_PINK
                size_hint_y: None
                height: adaptive_dp(50)
                on_press: root.create_savings_plan()

        # Повідомлення про статус
        Label:
            id: savings_message
            text: 'Введіть дані та створіть план'
            size_hint_y: None
            height: adaptive_dp(30)
            color: PRIMARY_PINK
            text_size: self.width, None
            halign: 'center'
            valign: 'middle'
            font_size: adaptive_font(14)

        # 3. БЛОК ВАШИХ АКТИВНИХ ПЛАНІВ
        Label:
            text: 'Ваші Цілі та Прогрес'
            font_size: adaptive_font(18)
            color: PRIMARY_PINK
            size_hint_y: None
            height: adaptive_dp(35)
            bold: True

        ScrollView:
            size_hint_y: 1
            bar_width: adaptive_dp(8)
            bar_color: PRIMARY_BLUE
            bar_inactive_color: PRIMARY_BLUE
            
            GridLayout:
                id: savings_container
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                spacing: adaptive_dp(12)
                padding: adaptive_dp(5)

        
<AITab>:
    name: "ai_tab"
    canvas.before:
        Color:
            rgba: LIGHT_BLUE
        Rectangle:
            pos: self.pos
            size: self.size
    
    BoxLayout:
        orientation: 'vertical'
        padding: adaptive_padding(40)
        spacing: adaptive_dp(20)
        
        LoginFormLogo:
            height: adaptive_dp(120) if not is_small_screen else adaptive_dp(90)
        
        Label:
            text: "AI Assistant"
            font_size: adaptive_font(28) if not is_small_screen else adaptive_font(24)
            bold: True
            color: PRIMARY_PINK
            size_hint_y: None
            height: adaptive_dp(40)
        
        Label:
            text: "Smart financial advice and predictions"
            font_size: adaptive_font(18) if not is_small_screen else adaptive_font(16)
            color: PRIMARY_BLUE
            halign: "center"
            text_size: self.width, None

<AccountTab>:
    name: "account_tab"
    canvas.before:
        Color:
            rgba: LIGHT_BLUE
        Rectangle:
            pos: self.pos
            size: self.size
    
    BoxLayout:
        orientation: 'vertical'
        padding: adaptive_padding(40)
        spacing: adaptive_dp(20)
        
        LoginFormLogo:
            height: adaptive_dp(120) if not is_small_screen else adaptive_dp(90)
        
        Label:
            text: "Account Settings"
            font_size: adaptive_font(28) if not is_small_screen else adaptive_font(24)
            bold: True
            color: PRIMARY_PINK
            size_hint_y: None
            height: adaptive_dp(40)
        
        Widget:
        
        BoxLayout:
            orientation: 'vertical'
            spacing: adaptive_dp(15)
            size_hint_y: None
            height: adaptive_dp(200) if not is_small_screen else adaptive_dp(160)
            
            Label:
                id: username_label
                text: "Username: "
                font_size: adaptive_font(18) if not is_small_screen else adaptive_font(16)
                color: PRIMARY_PINK
                size_hint_y: None
                height: adaptive_dp(30)
            
            Label:
                id: email_label
                text: "Email: "
                font_size: adaptive_font(18) if not is_small_screen else adaptive_font(16)
                color: PRIMARY_BLUE
                size_hint_y: None
                height: adaptive_dp(30)
            
            Widget:
            
            StyledButton:
                text: "Logout"
                background_color: PRIMARY_PINK
                height: adaptive_dp(60) if not is_small_screen else adaptive_dp(50)
                on_press: root.logout()

# ГОЛОВНИЙ ДАШБОРД
<DashboardScreen>:
    name: "dashboard_screen"
    canvas.before:
        Color:
            rgba: LIGHT_BLUE
        Rectangle:
            pos: self.pos
            size: self.size
    
    BoxLayout:
        orientation: "vertical"
        
        ScreenManager:
            id: tab_manager
            canvas.before:
                Color:
                    rgba: LIGHT_BLUE
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            HomeTab:
            AnalyticsTab:
            SavingsTab:
            AITab:
            AccountTab:

        BoxLayout:
            size_hint_y: None
            height: adaptive_dp(70) if not is_small_screen else adaptive_dp(60)
            padding: adaptive_dp(10)
            spacing: adaptive_dp(10)
            canvas.before:
                Color:
                    rgba: PRIMARY_BLUE
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [adaptive_dp(25), adaptive_dp(25), 0, 0]

            BottomMenuItem:
                tab_name: "home"
                icon_source: "icons/home.png"

            BottomMenuItem:
                tab_name: "analytics"
                icon_source: "icons/analytics.png"

            BottomMenuItem:
                tab_name: "savings"
                icon_source: "icons/savings.png"

            BottomMenuItem:
                tab_name: "ai"
                icon_source: "icons/ai.png"

            BottomMenuItem:
                tab_name: "account"
                icon_source: "icons/account.png"